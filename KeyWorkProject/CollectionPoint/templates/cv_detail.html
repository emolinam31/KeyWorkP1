{% extends 'base.html' %}

{% block title %}Mi CV - KeyWork{% endblock %}

{% block extra_css %}
<style>
    .cv-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 2rem;
    }
    
    .cv-card {
        background-color: rgba(255, 255, 255, 0.1);
        border: none;
        border-radius: 15px;
        backdrop-filter: blur(10px);
        color: white;
        margin-bottom: 2rem;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    
    .cv-header {
        background: linear-gradient(135deg, rgba(0, 195, 255, 0.3), rgba(0, 195, 255, 0.1));
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding: 1.5rem;
        position: relative;
    }
    
    .cv-header h2 {
        margin: 0;
        font-size: 1.8rem;
        font-weight: 600;
    }
    
    .cv-type-badge {
        position: absolute;
        top: 1.5rem;
        right: 1.5rem;
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .badge-document {
        background-color: rgba(52, 152, 219, 0.2);
        color: #3498db;
        border: 1px solid rgba(52, 152, 219, 0.3);
    }
    
    .badge-image {
        background-color: rgba(46, 204, 113, 0.2);
        color: #2ecc71;
        border: 1px solid rgba(46, 204, 113, 0.3);
    }
    
    .badge-audio {
        background-color: rgba(155, 89, 182, 0.2);
        color: #9b59b6;
        border: 1px solid rgba(155, 89, 182, 0.3);
    }
    
    .cv-info {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .cv-info-item {
        background-color: rgba(0, 0, 0, 0.2);
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
    }
    
    .cv-info-item i {
        margin-right: 0.5rem;
        color: #00c3ff;
    }
    
    .cv-body {
        padding: 2rem;
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }
    
    .cv-section {
        background-color: rgba(0, 0, 0, 0.15);
        border-radius: 10px;
        padding: 1.5rem;
        border-left: 4px solid #00c3ff;
    }
    
    .cv-section-title {
        font-size: 1.4rem;
        margin-bottom: 1.2rem;
        color: #fff;
        display: flex;
        align-items: center;
    }
    
    .cv-section-title i {
        margin-right: 0.7rem;
        color: #00c3ff;
    }
    
    .cv-column {
        padding: 0 1rem;
    }
    
    .preview-container {
        width: 100%;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        background-color: rgba(0, 0, 0, 0.2);
    }
    
    .image-container {
        text-align: center;
        width: 100%;
    }
    
    .image-container img {
        max-width: 100%;
        max-height: 600px;
        border-radius: 8px;
    }
    
    .extracted-text-container {
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        padding: 1.5rem;
        max-height: 600px;
        overflow-y: auto;
    }
    
    .extracted-text {
        white-space: normal; /* Cambiado de pre-wrap a normal */
        font-family: 'Segoe UI', Arial, sans-serif; /* Cambiado de monospace a una fuente más legible */
        line-height: 1.6;
        color: #e0e0e0;
        text-align: left;
    }
    
    .action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 1.5rem;
    }
    
    .btn-action {
        padding: 0.7rem 1.5rem;
        border-radius: 50px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        border: none;
    }
    
    .btn-action i {
        margin-right: 0.5rem;
    }
    
    .btn-primary {
        background: linear-gradient(45deg, #3498db, #00c3ff);
        color: white;
    }
    
    .btn-primary:hover {
        background: linear-gradient(45deg, #00c3ff, #3498db);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        color: white;
    }
    
    .btn-secondary {
        background-color: rgba(255, 255, 255, 0.1);
        color: white;
    }
    
    .btn-secondary:hover {
        background-color: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        color: white;
    }
    
    .btn-warning {
        background: linear-gradient(45deg, #f39c12, #e67e22);
        color: white;
    }
    
    .btn-warning:hover {
        background: linear-gradient(45deg, #e67e22, #f39c12);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        color: white;
    }
    
    .btn-success {
        background: linear-gradient(45deg, #27ae60, #2ecc71);
        color: white;
    }
    
    .btn-success:hover {
        background: linear-gradient(45deg, #2ecc71, #27ae60);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        color: white;
    }
    
    .alert {
        background-color: rgba(0, 0, 0, 0.2);
        color: white;
        border: none;
        border-left: 4px solid;
        padding: 1rem 1.5rem;
        border-radius: 8px;
    }
    
    .alert-success {
        border-left-color: #2ecc71;
    }
    
    .alert-danger {
        border-left-color: #e74c3c;
    }
    
    .alert-warning {
        border-left-color: #f39c12;
    }
    
    .alert-info {
        border-left-color: #3498db;
    }
    
    .no-text-alert {
        border: 2px dashed rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        padding: 2rem;
        text-align: center;
        background-color: rgba(0, 0, 0, 0.1);
    }
    
    .no-text-alert i {
        font-size: 2.5rem;
        color: #f39c12;
        margin-bottom: 1rem;
        display: block;
    }
    
    .wave-divider {
        height: 50px;
        width: 100%;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 120' preserveAspectRatio='none'%3E%3Cpath d='M321.39,56.44c58-10.79,114.16-30.13,172-41.86,82.39-16.72,168.19-17.73,250.45-.39C823.78,31,906.67,72,985.66,92.83c70.05,18.48,146.53,26.09,214.34,3V0H0V27.35A600.21,600.21,0,0,0,321.39,56.44Z' fill='rgba(0, 195, 255, 0.1)'%3E%3C/path%3E%3C/svg%3E");
        background-size: cover;
        margin-top: -1px;
        margin-bottom: -1px;
    }
    
    /* Nuevo estilo para los campos de la hoja de vida */
    .cv-field {
        margin-bottom: 0.8rem;
    }
    
    .cv-field-label {
        font-weight: bold;
        color: #00c3ff;
        margin-right: 0.5rem;
    }
    
    .cv-field-value {
        color: #e0e0e0;
    }
</style>
{% endblock %}

{% block content %}
<div class="cv-container">
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} mb-4">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <div class="cv-card">
        <div class="cv-header">
            <h2><i class="fas fa-file-alt"></i> Detalles de mi CV</h2>
            
            <span class="cv-type-badge 
                {% if cv.upload_type == 'document' %}badge-document
                {% elif cv.upload_type == 'image' %}badge-image
                {% else %}badge-audio{% endif %}">
                {{ cv.get_upload_type_display }}
            </span>
            
            <div class="cv-info">
                <div class="cv-info-item">
                    <i class="fas fa-calendar-alt"></i>
                    Subido: {{ cv.uploaded_at|date:"d/m/Y H:i" }}
                </div>
                <div class="cv-info-item">
                    <i class="fas fa-file"></i>
                    Tipo: {{ cv.get_upload_type_display }}
                </div>
            </div>
        </div>
        
        <div class="wave-divider"></div>
        
        <div class="cv-body">
            {% if cv.upload_type == 'image' %}
                <div class="row">
                    <div class="col-md-4">
                        <div class="cv-section">
                            <h3 class="cv-section-title"><i class="fas fa-image"></i> Imagen Original</h3>
                            <div class="preview-container">
                                <div class="image-container">
                                    <img src="{{ cv.file.url }}" alt="CV Image">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="cv-section">
                            <h3 class="cv-section-title"><i class="fas fa-align-left"></i> Texto Extraído</h3>
                            
                            {% if cv.extracted_text %}
                                <div class="extracted-text-container">
                                    <div class="extracted-text">{{ cv.extracted_text }}</div>
                                </div>
                            {% else %}
                                <div class="no-text-alert">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <p>No se ha extraído texto de esta imagen.</p>
                                    <a href="{% url 'process_ocr' cv.pk %}" class="btn btn-action btn-warning mt-3">
                                        <i class="fas fa-magic"></i> Procesar con OCR
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% elif cv.upload_type == 'document' %}
                <!-- Documento PDF: Se ha quitado la sección de visualización del PDF -->
                <div class="cv-section">
                    <h3 class="cv-section-title"><i class="fas fa-align-left"></i> Texto Extraído</h3>
                    
                    {% if cv.extracted_text %}
                        <div class="extracted-text-container">
                            <div class="extracted-text">{{ cv.extracted_text }}</div>
                        </div>
                    {% else %}
                        <div class="no-text-alert">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>No se ha extraído texto de este PDF.</p>
                        </div>
                    {% endif %}
                </div>
            {% endif %}
            
            <div class="cv-section">
                <h3 class="cv-section-title"><i class="fas fa-cogs"></i> Acciones</h3>
                
                <div class="action-buttons">
                    <a href="{% url 'home' %}" class="btn btn-action btn-secondary">
                        <i class="fas fa-arrow-left"></i> Volver a Inicio
                    </a>
                    
                    <a href="{% url 'profile' %}" class="btn btn-action btn-secondary">
                        <i class="fas fa-user"></i> Ir a mi Perfil
                    </a>
                    
                    <a href="{% url 'upload_cv' %}" class="btn btn-action btn-primary">
                        <i class="fas fa-sync-alt"></i> Actualizar CV
                    </a>
                    
                    <!-- Nuevo botón para corregir CV -->
                    <a href="#" class="btn btn-action btn-success" data-bs-toggle="modal" data-bs-target="#correctModal">
                        <i class="fas fa-spell-check"></i> Corregir mi CV
                    </a>
                    
                    {% if cv.upload_type == 'image' and cv.extracted_text %}
                        <a href="{% url 'process_ocr' cv.pk %}" class="btn btn-action btn-warning">
                            <i class="fas fa-redo"></i> Reprocesar OCR
                        </a>
                    {% endif %}
                    
                    <button type="button" class="btn btn-action btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                        <i class="fas fa-trash"></i> Eliminar CV
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para confirmar eliminación -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="deleteModalLabel">Confirmar Eliminación</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> Esta acción eliminará permanentemente tu CV actual. ¿Estás seguro?
                </div>
                <p>Una vez eliminado, no podrás recuperar este documento.</p>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <a href="{% url 'delete_cv' cv.pk %}" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Sí, Eliminar
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Modal para corregir CV -->
<div class="modal fade" id="correctModal" tabindex="-1" aria-labelledby="correctModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="correctModalLabel">Corregir mi CV</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-4">
                    <i class="fas fa-info-circle"></i> Corrige el texto extraído de tu CV para mejorar errores de extracción u ortografía.
                </div>
                
                <form id="correctCVForm" method="post" action="#">
                    {% csrf_token %}
                    <div class="form-group mb-3">
                        <label for="correctedText" class="form-label">Texto corregido:</label>
                        <textarea id="correctedText" name="corrected_text" class="form-control bg-dark text-light" rows="15" style="font-family: 'Segoe UI', Arial, sans-serif;">{{ cv.extracted_text }}</textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" form="correctCVForm" class="btn btn-success">
                    <i class="fas fa-save"></i> Guardar Correcciones
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// JavaScript para formatear el texto extraído y quitar saltos de línea innecesarios
document.addEventListener('DOMContentLoaded', function() {
    // Formatear el texto extraído
    const extractedText = document.querySelector('.extracted-text');
    if (extractedText) {
        // Reemplazamos múltiples espacios o saltos de línea con un solo espacio
        let text = extractedText.innerHTML;
        text = text.replace(/\n\s*\n/g, ' '); // Reemplazar múltiples saltos de línea con un espacio
        extractedText.innerHTML = text;
    }
    
    // También formatear el texto en el modal de corrección
    const textArea = document.getElementById('correctedText');
    if (textArea) {
        let text = textArea.value;
        text = text.replace(/\n\s*\n/g, ' '); // Reemplazar múltiples saltos de línea con un espacio
        textArea.value = text;
    }
});
</script>
{% endblock %}